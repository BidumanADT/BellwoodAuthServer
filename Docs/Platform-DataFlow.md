# Phase 1 - Data Flow Reference

**Visual guide to understand how data flows through the platform in Phase 1**

---

## ?? Login Flow

```
???????????????????
?  Admin Portal   ?
?   (Browser)     ?
???????????????????
         ?
         ? 1. POST /login
         ?    { username: "alice", password: "password" }
         ?
???????????????????
?   AuthServer    ?
?  localhost:5001 ?
???????????????????
         ?
         ? 2. Validate credentials
         ? 3. Generate JWT with claims:
         ?    - sub: "alice"
         ?    - uid: "a1b2c3d4-..."
         ?    - userId: "a1b2c3d4-..." ? NEW (Phase 1)
         ?    - role: "admin"
         ?
         ?
???????????????????
?  Admin Portal   ?
?  (JWT stored)   ?
???????????????????
```

---

## ?? Create Booking Flow

```
???????????????????
?  Admin Portal   ?
?  (alice logged) ?
???????????????????
         ?
         ? 1. POST /bookings
         ?    Authorization: Bearer eyJ...
         ?    { passengerName: "John Doe", ... }
         ?
???????????????????
?    AdminAPI     ?
?  localhost:7100 ?
???????????????????
         ?
         ? 2. Extract claims from JWT:
         ?    userId = "a1b2c3d4-..."
         ?    role = "admin"
         ?
         ? 3. Create booking record:
         ?    booking.CreatedByUserId = userId ? NEW (Phase 1)
         ?    booking.CreatedUtc = now
         ?
         ? 4. Save to database
         ?
         ?
???????????????????
?    Database     ?
?  BookingRecord  ?
?  {              ?
?    BookingId: "BK-123"             ?
?    PassengerName: "John Doe"       ?
?    CreatedByUserId: "a1b2c3d4-..." ? ? NEW
?    CreatedUtc: "2026-01-11..."     ?
?  }              ?
???????????????????
```

---

## ?? List Bookings Flow (Admin User)

```
???????????????????
?  Admin Portal   ?
?  (alice logged) ?
???????????????????
         ?
         ? 1. GET /bookings/list
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "a1b2c3d4-..."
         ?    role = "admin"
         ?
         ? 3. Check role:
         ?    IsStaffOrAdmin? YES
         ?    ? Return ALL bookings
         ?
         ?
???????????????????
?    Database     ?
?  Query:         ?
?  SELECT *       ?
?  FROM Bookings  ?
?  (no filter)    ? ? Admin sees all
???????????????????
         ?
         ?
???????????????????
?    AdminAPI     ?
?  Response:      ?
?  [              ?
?    {            ?
?      BookingId: "BK-123"             ?
?      CreatedByUserId: "a1b2c3d4-..." ? ? alice's
?    },           ?
?    {            ?
?      BookingId: "BK-124"             ?
?      CreatedByUserId: "x9y8z7w6-..." ? ? chris's
?    }            ?
?  ]              ?
???????????????????
         ?
         ?
???????????????????
?  Admin Portal   ?
?  Displays:      ?
?  - BK-123 (by a1b2c3d4) ?
?  - BK-124 (by x9y8z7w6) ?
???????????????????
```

---

## ?? List Bookings Flow (Booker User)

```
???????????????????
?  Admin Portal   ?
?  (chris logged) ?
???????????????????
         ?
         ? 1. GET /bookings/list
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "x9y8z7w6-..."
         ?    role = "booker"
         ?
         ? 3. Check role:
         ?    IsStaffOrAdmin? NO
         ?    IsBooker? YES
         ?    ? Filter by CreatedByUserId
         ?
         ?
???????????????????
?    Database     ?
?  Query:         ?
?  SELECT *       ?
?  FROM Bookings  ?
?  WHERE CreatedByUserId = "x9y8z7w6-..." ? ? Filter
???????????????????
         ?
         ?
???????????????????
?    AdminAPI     ?
?  Response:      ?
?  [              ?
?    {            ?
?      BookingId: "BK-124"             ?
?      CreatedByUserId: "x9y8z7w6-..." ? ? Only chris's
?    }            ?
?  ]              ?
???????????????????
         ?
         ?
???????????????????
?  Admin Portal   ?
?  Displays:      ?
?  - BK-124 (by x9y8z7w6) ?
?  (BK-123 not shown)      ?
???????????????????
```

---

## ?? View Booking Detail Flow (Authorized)

```
???????????????????
?  Admin Portal   ?
?  (alice logged) ?
???????????????????
         ?
         ? 1. GET /bookings/BK-123
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "a1b2c3d4-..."
         ?    role = "admin"
         ?
         ? 3. Fetch booking from DB:
         ?    booking.CreatedByUserId = "a1b2c3d4-..."
         ?
         ? 4. Check authorization:
         ?    CanAccessBooking(user, booking)?
         ?    ? IsAdmin? YES
         ?    ? ALLOW
         ?
         ?
???????????????????
?    AdminAPI     ?
?  Response:      ?
?  200 OK         ?
?  {              ?
?    BookingId: "BK-123"               ?
?    CreatedByUserId: "a1b2c3d4-..."   ?
?    ModifiedByUserId: "a1b2c3d4-..."  ?
?    ModifiedOnUtc: "2026-01-11..."    ?
?  }              ?
???????????????????
         ?
         ?
???????????????????
?  Admin Portal   ?
?  Displays:      ?
?  Booking BK-123 ?
?  Created by: a1b2c3d4 ?
?  Modified by: a1b2c3d4 ?
???????????????????
```

---

## ?? View Booking Detail Flow (Unauthorized)

```
???????????????????
?  Admin Portal   ?
?  (chris logged) ?
???????????????????
         ?
         ? 1. GET /bookings/BK-123
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "x9y8z7w6-..."
         ?    role = "booker"
         ?
         ? 3. Fetch booking from DB:
         ?    booking.CreatedByUserId = "a1b2c3d4-..." (alice's)
         ?
         ? 4. Check authorization:
         ?    CanAccessBooking(user, booking)?
         ?    ? IsAdmin? NO
         ?    ? CreatedBy matches? NO
         ?    ? DENY
         ?
         ?
???????????????????
?    AdminAPI     ?
?  Response:      ?
?  403 Forbidden  ?
???????????????????
         ?
         ?
???????????????????
?  Admin Portal   ?
?  Catches 403:   ?
?  "You don't have ?
?  permission to  ?
?  view this booking" ?
?  ? Redirect to list ?
???????????????????
```

---

## ? Cancel Booking Flow (Audit Trail)

```
???????????????????
?  Admin Portal   ?
?  (alice logged) ?
???????????????????
         ?
         ? 1. POST /bookings/BK-123/cancel
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "a1b2c3d4-..."
         ?    role = "admin"
         ?
         ? 3. Fetch booking from DB
         ?
         ? 4. Check authorization:
         ?    CanAccessBooking? YES (admin)
         ?
         ? 5. Update booking:
         ?    booking.Status = "Cancelled"
         ?    booking.ModifiedByUserId = "a1b2c3d4-..." ? NEW
         ?    booking.ModifiedOnUtc = now ? NEW
         ?
         ? 6. Save changes
         ?
         ?
???????????????????
?    Database     ?
?  BookingRecord  ?
?  {              ?
?    BookingId: "BK-123"                ?
?    Status: "Cancelled"                ?
?    CreatedByUserId: "a1b2c3d4-..."    ?
?    ModifiedByUserId: "a1b2c3d4-..."   ? ? Audit
?    ModifiedOnUtc: "2026-01-11..."     ? ? Audit
?  }              ?
???????????????????
         ?
         ?
???????????????????
?    AdminAPI     ?
?  Response:      ?
?  200 OK         ?
???????????????????
         ?
         ?
???????????????????
?  Admin Portal   ?
?  "Booking cancelled" ?
?  Shows audit trail:  ?
?  - Modified by: a1b2c3d4 ?
???????????????????
```

---

## ?? Driver Assignment Flow

```
???????????????????
?  Admin Portal   ?
?  (alice logged) ?
???????????????????
         ?
         ? 1. POST /bookings/BK-123/assign-driver
         ?    { driverUid: "driver-001" }
         ?    Authorization: Bearer eyJ...
         ?
???????????????????
?    AdminAPI     ?
???????????????????
         ?
         ? 2. Extract claims:
         ?    userId = "a1b2c3d4-..."
         ?    role = "admin"
         ?
         ? 3. Update booking:
         ?    booking.AssignedDriverUid = "driver-001"
         ?    booking.ModifiedByUserId = "a1b2c3d4-..." ? Audit
         ?    booking.ModifiedOnUtc = now ? Audit
         ?
         ?
???????????????????
?    Database     ?
?  BookingRecord  ?
?  {              ?
?    AssignedDriverUid: "driver-001"    ?
?    ModifiedByUserId: "a1b2c3d4-..."   ? ? Admin
?  }              ?
???????????????????

Later...

???????????????????
?  Driver App     ?
?  (charlie)      ?
???????????????????
         ?
         ? JWT claims:
         ? - uid: "driver-001"
         ? - userId: "x9y8z7w6-..." (charlie's GUID)
         ?
         ? GET /driver/rides/today
         ?
???????????????????
?    AdminAPI     ?
?  Query:         ?
?  WHERE AssignedDriverUid = "driver-001" ? ? uid claim
???????????????????
         ?
         ?
???????????????????
?  Driver App     ?
?  Sees:          ?
?  - BK-123 (assigned to him) ?
???????????????????
```

---

## ?? Phase 1 Data Structure

### JWT Token (in memory)
```json
{
  "sub": "alice",
  "uid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "userId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "role": "admin",
  "exp": 1704996000
}
```

### Booking Record (in database)
```json
{
  "bookingId": "BK-123",
  "passengerName": "John Doe",
  "status": "Confirmed",
  "assignedDriverUid": "driver-001",
  "createdUtc": "2026-01-10T10:00:00Z",
  "createdByUserId": "a1b2c3d4-...",     // ? Phase 1
  "modifiedByUserId": "a1b2c3d4-...",    // ? Phase 1
  "modifiedOnUtc": "2026-01-10T15:30:00Z" // ? Phase 1
}
```

### Portal Display (in UI)
```
Booking BK-123
????????????????????????
Passenger: John Doe
Status: Confirmed
Assigned Driver: driver-001

Audit Trail:
  Created: Jan 10, 2026 10:00 AM
  Created By: a1b2c3d4-...           ? Phase 1
  
  Last Modified: Jan 10, 2026 3:30 PM
  Modified By: a1b2c3d4-...          ? Phase 1
```

---

## ?? Key Claim Usage

| Claim | Source | Usage in AdminAPI | Usage in Portal |
|-------|--------|-------------------|-----------------|
| `sub` | AuthServer | Logging only | Display username |
| `uid` | AuthServer | Driver assignment matching | N/A |
| `userId` | AuthServer | **CreatedByUserId** field | Display audit info |
| `role` | AuthServer | **Access filtering** | Role-based UI (Phase 2) |

---

## ?? Role-Based Filtering Summary

### Admin User
```
JWT: { role: "admin", userId: "a1b2c3d4-..." }

GET /bookings/list
? Returns: ALL bookings (no filter)

GET /bookings/BK-123 (owned by alice)
? Returns: 200 OK

GET /bookings/BK-124 (owned by chris)
? Returns: 200 OK (admin can see everything)
```

### Booker User
```
JWT: { role: "booker", userId: "x9y8z7w6-..." }

GET /bookings/list
? Returns: WHERE CreatedByUserId = "x9y8z7w6-..."

GET /bookings/BK-123 (owned by alice)
? Returns: 403 Forbidden

GET /bookings/BK-124 (owned by chris)
? Returns: 200 OK (owns it)
```

### Driver User
```
JWT: { role: "driver", uid: "driver-001", userId: "y8x7w6v5-..." }

GET /driver/rides/today
? Returns: WHERE AssignedDriverUid = "driver-001"

GET /bookings/BK-123 (assigned to driver-001)
? Returns: 200 OK

GET /bookings/BK-125 (assigned to driver-002)
? Returns: 403 Forbidden
```

---

## ? Phase 1 Data Flow Complete

**Data flows correctly when:**
- ? AuthServer issues `userId` in JWT
- ? AdminAPI extracts `userId` from JWT
- ? AdminAPI stores `userId` in `CreatedByUserId`
- ? AdminAPI filters by `CreatedByUserId` based on role
- ? AdminAPI verifies ownership before mutations
- ? Portal displays audit trail from responses

---

**Use this reference to understand how data moves through the system in Phase 1!** ???
